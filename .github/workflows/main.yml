# CI/CD 流水线配置文件
# 用于自动化构建、打包和发布后端与前端项目
name: CI/CD Pipeline

# 触发条件配置
on:
  # 推送代码到 main 或 master 分支时触发
  push:
    branches: [ main, master ]
  # 提交 Pull Request 到 main 或 master 分支时触发
  pull_request:
    branches: [ main, master ]
  # 手动触发配置
  workflow_dispatch:
    inputs:
      # 手动触发时可以指定版本号
      version:
        description: 'Version number for this release'
        required: true
        default: '1.0.0'

# 定义构建作业
jobs:
  build:
    # 运行在最新版的 Ubuntu 虚拟机上
    runs-on: ubuntu-latest
    # 关键修复：添加权限声明，授予创建 Release 的权限
    permissions:
      contents: write  # 必须：授予写入仓库内容（创建 Release）的权限
      packages: read   # 可选：如果不需要可以删除，仅作为基础权限补充

    # 构建步骤
    steps:
      # 1. 检出代码到工作目录
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 检出所有历史记录，确保版本信息完整
          fetch-depth: 0

      # 2. 配置 Java 17 环境
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'               # 使用 Java 17 版本
          distribution: 'temurin'          # 使用 Eclipse Temurin 发行版
          cache: gradle                    # 缓存 Gradle 依赖，加速构建

      # 3. 配置 Bun 环境
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest             # 使用最新版本的 Bun

      # 4. 授予 gradlew 脚本执行权限
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. 构建后端模块
      - name: Build backend modules
        run: ./gradlew clean bootJar -x test
        # 命令说明：
        #   clean: 清理之前的构建产物
        #   bootJar: 构建可执行 JAR 文件
        #   -x test: 跳过测试，加快构建速度

      # 6. 安装前端依赖
      - name: Install frontend dependencies
        run: bun install
        working-directory: ./witstalk-web  # 切换到前端项目目录
        # 说明：使用 Bun 安装依赖，确保依赖版本与 bun.lockb 完全一致

      # 7. 构建前端项目
      - name: Build frontend
        run: bun run build
        working-directory: ./witstalk-web  # 切换到前端项目目录
        # 说明：使用 Bun 执行 build 脚本，生成生产环境构建产物

      # 8. 生成版本号
      - name: Generate version number
        id: generate-version  # 步骤 ID，用于后续引用输出
        run: |
          if [ "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Generate version based on timestamp
            VERSION="1.0.0-$(date +'%Y%m%d%H%M%S')"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      # 9. 创建输出目录结构
      - name: Create output directory
        run: mkdir -p build-output/jars build-output/web
        # 目录说明：
        #   build-output/jars: 存放后端 JAR 文件
        #   build-output/web: 存放前端构建产物

      # 10. 复制后端 JAR 文件到输出目录（增加日志，便于排查路径问题）
      - name: Copy backend JAR files
        run: |
          echo "=== 查找 JAR 文件 ==="
          find . -name "*.jar" -path "*/build/libs/*" ! -name "*-plain.jar"
          echo "=== 复制 JAR 文件 ==="
          find . -name "*.jar" -path "*/build/libs/*" ! -name "*-plain.jar" -exec cp {} build-output/jars/ \;
          echo "=== 输出目录 JAR 文件列表 ==="
          ls -la build-output/jars/
        # 命令说明：
        #   find . -name "*.jar": 查找所有 JAR 文件
        #   -path "*/build/libs/*": 只在 build/libs 目录下查找
        #   ! -name "*-plain.jar": 排除带有 -plain 后缀的 JAR 文件（这些是不包含依赖的 JAR）
        #   -exec cp {} build-output/jars/ \;: 将找到的文件复制到输出目录

      # 11. 复制前端构建产物到输出目录（增加日志，便于排查路径问题）
      - name: Copy frontend build files
        run: |
          echo "=== 前端构建目录文件列表 ==="
          ls -la ./witstalk-web/dist/
          echo "=== 复制前端文件 ==="
          cp -r ./witstalk-web/dist/* build-output/web/
          echo "=== 输出目录前端文件列表 ==="
          ls -la build-output/web/
        # 说明：将前端构建生成的 dist 目录下的所有文件复制到输出目录

      # 12. 更新 build.gradle.kts 中的版本号
      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/version = \"[0-9]*\.[0-9]*\.[0-9]*\"/version = \"${{ steps.generate-version.outputs.VERSION }}\"/g" build.gradle.kts
        # 说明：使用 sed 命令替换 build.gradle.kts 文件中的版本号

      # 13. 上传后端 JARs as artifacts
      - name: Upload backend JARs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-jars-${{ steps.generate-version.outputs.VERSION }}  #  artifact 名称，包含版本号
          path: build-output/jars/  # 要上传的文件路径
          retention-days: 30  # 保留 30 天

      # 14. 上传前端 build as artifact
      - name: Upload frontend build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ steps.generate-version.outputs.VERSION }}  # artifact 名称，包含版本号
          path: build-output/web/  # 要上传的文件路径
          retention-days: 30  # 保留 30 天

      # 15. 创建 GitHub Release（仅在 main 分支推送时执行）
      - name: Create release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'  # 仅在 main 分支推送时执行
        uses: softprops/action-gh-release@v2  # 使用 GitHub Release 工具
        with:
          tag_name: v${{ steps.generate-version.outputs.VERSION }}  # 标签名称，包含 v 前缀
          name: Release v${{ steps.generate-version.outputs.VERSION }}  # Release 名称
          body: |
            ## What's Changed
            
            - Automated release from GitHub Actions
          files: |
            build-output/jars/*.jar
            build-output/web/*
          draft: false  # 不创建草稿 Release
          prerelease: false  # 不标记为预发布
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 提供的令牌，用于创建 Release
