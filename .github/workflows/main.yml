# CI/CD æµæ°´çº¿é…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºã€æ‰“åŒ…å’Œå‘å¸ƒæŒ‡å®šæ¨¡å—çš„åç«¯ JAR åŠå‰ç«¯å‹ç¼©åŒ…
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for this release'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¿…é¡»æ‹‰å–å®Œæ•´å†å²ï¼Œæ‰èƒ½è·å–commitä¿¡æ¯

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build backend modules
        run: ./gradlew clean bootJar -x test

      - name: Install frontend dependencies
        run: bun install
        working-directory: ./witstalk-web

      - name: Build frontend
        run: bun run build
        working-directory: ./witstalk-web

      - name: Generate version number
        id: generate-version
        run: |
          if [ "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="1.0.0-$(date +'%Y%m%d%H%M%S')"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      # æ–°å¢æ­¥éª¤ï¼šè·å–å½“å‰Commitä¿¡æ¯
      - name: Get current commit info
        id: commit-info
        run: |
          # è·å–å®Œæ•´commit hash
          FULL_COMMIT_HASH=$(git rev-parse HEAD)
          # è·å–çŸ­commit hashï¼ˆå‰7ä½ï¼‰
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          # è·å–æäº¤ä½œè€…
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an <%ae>')
          # è·å–æäº¤ä¿¡æ¯ï¼ˆæ ‡é¢˜ï¼‰
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          # è·å–æäº¤è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰
          COMMIT_BODY=$(git log -1 --pretty=format:'%b' | head -n 10)  # åªå–å‰10è¡Œï¼Œé¿å…è¿‡é•¿
          # è·å–æäº¤æ—¶é—´
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M:%S')
          
          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "FULL_COMMIT_HASH=$FULL_COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "COMMIT_BODY=$COMMIT_BODY" >> $GITHUB_OUTPUT
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_OUTPUT
          
          # æ‰“å°è°ƒè¯•ä¿¡æ¯
          echo "=== å½“å‰Commitä¿¡æ¯ ==="
          echo "å®Œæ•´Hash: $FULL_COMMIT_HASH"
          echo "çŸ­Hash: $SHORT_COMMIT_HASH"
          echo "ä½œè€…: $COMMIT_AUTHOR"
          echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
          echo "æäº¤æ—¶é—´: $COMMIT_DATE"

      - name: Prepare release artifacts
        run: |
          # åˆ›å»ºç»Ÿä¸€è¾“å‡ºç›®å½•
          mkdir -p release-artifacts
          
          # ========== ç¬¬ä¸€æ­¥ï¼šå…¨é‡æ’æŸ¥æ‰€æœ‰ JAR æ–‡ä»¶ï¼ˆå…³é”®è°ƒè¯•ï¼‰ ==========
          echo "=== ã€è°ƒè¯•ã€‘é¡¹ç›®ä¸­æ‰€æœ‰çš„ JAR æ–‡ä»¶ï¼ˆå«è·¯å¾„ï¼‰==="
          find . -name "*.jar" | sort
          echo "=== ã€è°ƒè¯•ã€‘build/libs ç›®å½•ä¸‹çš„æ‰€æœ‰ JAR æ–‡ä»¶ ==="
          find . -path "*/build/libs/*" -name "*.jar" | sort
          
          # ========== ç¬¬äºŒæ­¥ï¼šå®½æ¾åŒ¹é…æŒ‡å®šæ¨¡å—çš„å¯å¯åŠ¨ JAR ==========
          echo -e "\n=== ç­›é€‰æŒ‡å®šæ¨¡å—çš„å¯å¯åŠ¨ JAR æ–‡ä»¶ ==="
          # å®šä¹‰éœ€è¦ä¿ç•™çš„æ¨¡å—åï¼ˆå®½æ¾åŒ¹é…ï¼šæ–‡ä»¶ååŒ…å«ä»»æ„ä¸€ä¸ªæ¨¡å—åå³å¯ï¼‰
          TARGET_MODULES="auth system gateway witstalk game file"
          # å…ˆæ‰¾åˆ°æ‰€æœ‰é plain çš„ JAR
          ALL_JARS=$(find . -path "*/build/libs/*" -name "*.jar" ! -name "*-plain.jar")
          echo "=== æ‰€æœ‰å¯å¯åŠ¨çš„ JAR åˆ—è¡¨ ==="
          echo "$ALL_JARS"
          
          # éå†ç›®æ ‡æ¨¡å—ï¼Œå®½æ¾åŒ¹é…ï¼ˆæ–‡ä»¶ååŒ…å«æ¨¡å—åå³ä¿ç•™ï¼‰
          for MODULE in $TARGET_MODULES; do
            echo -e "\n=== åŒ¹é…æ¨¡å—: $MODULE ==="
            MATCHED_JARS=$(echo "$ALL_JARS" | grep -i "$MODULE")  # -i å¿½ç•¥å¤§å°å†™
            if [ -n "$MATCHED_JARS" ]; then
              echo "æ‰¾åˆ°è¯¥æ¨¡å—çš„ JARï¼š"
              echo "$MATCHED_JARS"
              # å¤åˆ¶åˆ°è¾“å‡ºç›®å½•
              echo "$MATCHED_JARS" | xargs -I {} cp {} release-artifacts/
            else
              echo "âš ï¸ æœªæ‰¾åˆ° $MODULE æ¨¡å—çš„å¯å¯åŠ¨ JAR"
            fi
          done
          
          # ========== ç¬¬ä¸‰æ­¥ï¼šéªŒè¯åç«¯ JAR å¤åˆ¶ç»“æœ ==========
          echo -e "\n=== å¤åˆ¶åˆ° release-artifacts çš„åç«¯ JAR åˆ—è¡¨ ==="
          ls -la release-artifacts/*.jar || echo "âŒ æœªå¤åˆ¶åˆ°ä»»ä½•åç«¯ JAR æ–‡ä»¶"
          
          # ========== ç¬¬å››æ­¥ï¼šå‰ç«¯æ–‡ä»¶æ‰“åŒ… ==========
          echo -e "\n=== æ‰“åŒ…å‰ç«¯æ–‡ä»¶ ==="
          # å…ˆæ£€æŸ¥å‰ç«¯æ„å»ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "./witstalk-web/dist" ]; then
            cd ./witstalk-web/dist
            zip -r ../../release-artifacts/frontend-build-${{ steps.generate-version.outputs.VERSION }}.zip ./*
            cd -
            echo "âœ… å‰ç«¯æ–‡ä»¶æ‰“åŒ…å®Œæˆ"
          else
            echo "âš ï¸ å‰ç«¯æ„å»ºç›®å½• ./witstalk-web/dist ä¸å­˜åœ¨"
            # æ£€æŸ¥æ˜¯å¦æ˜¯ build ç›®å½•ï¼ˆéƒ¨åˆ†å‰ç«¯é¡¹ç›®è¾“å‡ºåˆ° buildï¼‰
            if [ -d "./witstalk-web/build" ]; then
              echo "ğŸ” å‘ç°å‰ç«¯æ„å»ºç›®å½•ä¸º ./witstalk-web/buildï¼Œå°è¯•æ‰“åŒ…"
              cd ./witstalk-web/build
              zip -r ../../release-artifacts/frontend-build-${{ steps.generate-version.outputs.VERSION }}.zip ./*
              cd -
              echo "âœ… å‰ç«¯æ–‡ä»¶ï¼ˆbuild ç›®å½•ï¼‰æ‰“åŒ…å®Œæˆ"
            fi
          fi
          
          # ========== ç¬¬äº”æ­¥ï¼šæœ€ç»ˆäº§ç‰©éªŒè¯ ==========
          echo -e "\n=== æœ€ç»ˆå‘å¸ƒäº§ç‰©åˆ—è¡¨ ==="
          ls -la release-artifacts/ || echo "âŒ release-artifacts ç›®å½•ä¸ºç©º"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ steps.generate-version.outputs.VERSION }}
          path: release-artifacts/
          retention-days: 30

      - name: Create release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.generate-version.outputs.VERSION }}
          name: Release v${{ steps.generate-version.outputs.VERSION }}
          # æ ¸å¿ƒä¿®æ”¹ï¼šæ•´åˆCommitä¿¡æ¯åˆ°å‘å¸ƒè¯´æ˜
          body: |
            ## å‘å¸ƒä¿¡æ¯
            - ç‰ˆæœ¬å·ï¼šv${{ steps.generate-version.outputs.VERSION }}
            - æ„å»ºCommitï¼š[${{ steps.commit-info.outputs.SHORT_COMMIT_HASH }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit-info.outputs.FULL_COMMIT_HASH }})
            - æäº¤ä½œè€…ï¼š${{ steps.commit-info.outputs.COMMIT_AUTHOR }}
            - æäº¤æ—¶é—´ï¼š${{ steps.commit-info.outputs.COMMIT_DATE }}
            
            ## æäº¤è¯´æ˜
            > ${{ steps.commit-info.outputs.COMMIT_MESSAGE }}
            ${{ steps.commit-info.outputs.COMMIT_BODY }}
            
            ## äº§ç‰©è¯´æ˜
            - åç«¯å¯æ‰§è¡Œ JARï¼šåŒ…å« authã€systemã€gatewayã€witstalkã€gameã€file æ¨¡å—ï¼ˆå¯ç›´æ¥å¯åŠ¨ï¼‰
            - JAR æ–‡ä»¶å‘½åæ ¼å¼ç¤ºä¾‹ï¼šmodule-name-version.jarï¼ˆå¦‚ auth-1.0.0.jarï¼‰
            - JAR æ–‡ä»¶å¯åŠ¨å‘½ä»¤ç¤ºä¾‹ï¼šjava -jar module-name-version.jar --spring.config.additional-location=file:./run/
            - å‰ç«¯æ„å»ºåŒ…ï¼šfrontend-build-${{ steps.generate-version.outputs.VERSION }}.zipï¼ˆè§£å‹åéƒ¨ç½²è‡³ Nginx ç­‰ Web æœåŠ¡å™¨ï¼‰
          files: |
            release-artifacts/*.jar
            release-artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
