# CI/CD æµæ°´çº¿é…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºã€æ‰“åŒ…å’Œå‘å¸ƒæŒ‡å®šæ¨¡å—çš„åç«¯ JAR åŠå‰ç«¯å‹ç¼©åŒ…
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for this release'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build backend modules
        run: ./gradlew clean bootJar -x test

      - name: Install frontend dependencies
        run: bun install
        working-directory: ./witstalk-web

      - name: Build frontend
        run: bun run build
        working-directory: ./witstalk-web

      - name: Generate version number
        id: generate-version
        run: |
          if [ "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION="1.0.0-$(date +'%Y%m%d%H%M%S')"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      # æ ¸å¿ƒä¿®å¤ï¼šç®€åŒ–åŒ¹é…è§„åˆ™ + å…¨é‡æ—¥å¿—è°ƒè¯•
      - name: Prepare release artifacts
        run: |
          # åˆ›å»ºç»Ÿä¸€è¾“å‡ºç›®å½•
          mkdir -p release-artifacts
          
          # ========== ç¬¬ä¸€æ­¥ï¼šå…¨é‡æ’æŸ¥æ‰€æœ‰ JAR æ–‡ä»¶ï¼ˆå…³é”®è°ƒè¯•ï¼‰ ==========
          echo "=== ã€è°ƒè¯•ã€‘é¡¹ç›®ä¸­æ‰€æœ‰çš„ JAR æ–‡ä»¶ï¼ˆå«è·¯å¾„ï¼‰==="
          find . -name "*.jar" | sort
          echo "=== ã€è°ƒè¯•ã€‘build/libs ç›®å½•ä¸‹çš„æ‰€æœ‰ JAR æ–‡ä»¶ ==="
          find . -path "*/build/libs/*" -name "*.jar" | sort
          
          # ========== ç¬¬äºŒæ­¥ï¼šå®½æ¾åŒ¹é…æŒ‡å®šæ¨¡å—çš„å¯å¯åŠ¨ JAR ==========
          echo -e "\n=== ç­›é€‰æŒ‡å®šæ¨¡å—çš„å¯å¯åŠ¨ JAR æ–‡ä»¶ ==="
          # å®šä¹‰éœ€è¦ä¿ç•™çš„æ¨¡å—åï¼ˆå®½æ¾åŒ¹é…ï¼šæ–‡ä»¶ååŒ…å«ä»»æ„ä¸€ä¸ªæ¨¡å—åå³å¯ï¼‰
          TARGET_MODULES="auth system gateway witstalk game file"
          # å…ˆæ‰¾åˆ°æ‰€æœ‰é plain çš„ JAR
          ALL_JARS=$(find . -path "*/build/libs/*" -name "*.jar" ! -name "*-plain.jar")
          echo "=== æ‰€æœ‰å¯å¯åŠ¨çš„ JAR åˆ—è¡¨ ==="
          echo "$ALL_JARS"
          
          # éå†ç›®æ ‡æ¨¡å—ï¼Œå®½æ¾åŒ¹é…ï¼ˆæ–‡ä»¶ååŒ…å«æ¨¡å—åå³ä¿ç•™ï¼‰
          for MODULE in $TARGET_MODULES; do
            echo -e "\n=== åŒ¹é…æ¨¡å—: $MODULE ==="
            MATCHED_JARS=$(echo "$ALL_JARS" | grep -i "$MODULE")  # -i å¿½ç•¥å¤§å°å†™
            if [ -n "$MATCHED_JARS" ]; then
              echo "æ‰¾åˆ°è¯¥æ¨¡å—çš„ JARï¼š"
              echo "$MATCHED_JARS"
              # å¤åˆ¶åˆ°è¾“å‡ºç›®å½•
              echo "$MATCHED_JARS" | xargs -I {} cp {} release-artifacts/
            else
              echo "âš ï¸ æœªæ‰¾åˆ° $MODULE æ¨¡å—çš„å¯å¯åŠ¨ JAR"
            fi
          done
          
          # ========== ç¬¬ä¸‰æ­¥ï¼šéªŒè¯åç«¯ JAR å¤åˆ¶ç»“æœ ==========
          echo -e "\n=== å¤åˆ¶åˆ° release-artifacts çš„åç«¯ JAR åˆ—è¡¨ ==="
          ls -la release-artifacts/*.jar || echo "âŒ æœªå¤åˆ¶åˆ°ä»»ä½•åç«¯ JAR æ–‡ä»¶"
          
          # ========== ç¬¬å››æ­¥ï¼šå‰ç«¯æ–‡ä»¶æ‰“åŒ… ==========
          echo -e "\n=== æ‰“åŒ…å‰ç«¯æ–‡ä»¶ ==="
          # å…ˆæ£€æŸ¥å‰ç«¯æ„å»ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "./witstalk-web/dist" ]; then
            cd ./witstalk-web/dist
            zip -r ../../release-artifacts/frontend-build-${{ steps.generate-version.outputs.VERSION }}.zip ./*
            cd -
            echo "âœ… å‰ç«¯æ–‡ä»¶æ‰“åŒ…å®Œæˆ"
          else
            echo "âš ï¸ å‰ç«¯æ„å»ºç›®å½• ./witstalk-web/dist ä¸å­˜åœ¨"
            # æ£€æŸ¥æ˜¯å¦æ˜¯ build ç›®å½•ï¼ˆéƒ¨åˆ†å‰ç«¯é¡¹ç›®è¾“å‡ºåˆ° buildï¼‰
            if [ -d "./witstalk-web/build" ]; then
              echo "ğŸ” å‘ç°å‰ç«¯æ„å»ºç›®å½•ä¸º ./witstalk-web/buildï¼Œå°è¯•æ‰“åŒ…"
              cd ./witstalk-web/build
              zip -r ../../release-artifacts/frontend-build-${{ steps.generate-version.outputs.VERSION }}.zip ./*
              cd -
              echo "âœ… å‰ç«¯æ–‡ä»¶ï¼ˆbuild ç›®å½•ï¼‰æ‰“åŒ…å®Œæˆ"
            fi
          fi
          
          # ========== ç¬¬äº”æ­¥ï¼šæœ€ç»ˆäº§ç‰©éªŒè¯ ==========
          echo -e "\n=== æœ€ç»ˆå‘å¸ƒäº§ç‰©åˆ—è¡¨ ==="
          ls -la release-artifacts/ || echo "âŒ release-artifacts ç›®å½•ä¸ºç©º"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ steps.generate-version.outputs.VERSION }}
          path: release-artifacts/
          retention-days: 30

      - name: Create release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.generate-version.outputs.VERSION }}
          name: Release v${{ steps.generate-version.outputs.VERSION }}
          body: |
            ## å‘å¸ƒäº§ç‰©è¯´æ˜
            - åç«¯å¯æ‰§è¡Œ JAR æ–‡ä»¶ï¼šåŒ…å« authã€systemã€gatewayã€witstalkã€gameã€file æ¨¡å—
            - å‰ç«¯æ„å»ºåŒ…ï¼ˆZIPï¼‰ï¼šè§£å‹åéƒ¨ç½²åˆ° Web æœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰
          files: |
            release-artifacts/*.jar
            release-artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
